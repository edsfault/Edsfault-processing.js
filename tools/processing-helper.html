<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Processing Helper</title>

    <script src="../processing.js"></script>
    <script src="jsbeautify.js"></script>
  </head>
  <body onload="document.getElementById('code').focus()">
    <h1>Processing Helper</h1>
    <p>Paste your Processing code below and execute whichever options you require:</p>

    <h2>Processing Code</h2>
    <textarea rows="20" cols="80" id="code"></textarea>
    <br>  <input onclick="helper.runSketch();" type="button" value="Run"></input>
    &nbsp;<input onclick="helper.convertToJS();" type="button" value="Convert to JS"></input>
    &nbsp;<input onclick="helper.generateDataURI();" type="button" value="Generate Data URI"></input>
    &nbsp;<input onclick="helper.generateRefTest();" type="button" value="Generate Ref Test"></input>

    <h2>Canvas</h2>
    <canvas id="sketch" style="border: 1px solid"></canvas>

    <h2>Output</h2>
    <textarea rows="20" cols="80" id="output" readonly="readonly">None.</textarea>

    <script>
    var helper = {
        canvas: document.getElementById('sketch'),
        code:   document.getElementById('code'),
        output: document.getElementById('output'),
        p:      null,

        runSketch: function() {
          try {
            p = Processing(this.canvas, this.code.value);
          } catch (e) {
            this.output.value = "Error! Error was:\n" + e.toString();
          }
        },

        convertToJS: function() {
          try {
            this.output.value = js_beautify(
                                  Processing.parse(
                                    this.code.value, Processing(
                                      this.canvas, this.code.value))).replace(/\n\n\n+/g, '\n\n');
            this.output.select();
          } catch (e) {
            this.output.value = "Parser Error! Error was:\n" + e.toString();
          }
        },

        generateDataURI: function() {
          // Run the sketch first, in case the user hasn't
          this.runSketch();
          this.output.value = this.canvas.toDataURL();
          this.output.select();
        },

        generateRefTest: function() {
          // Run the sketch first, in case the user hasn't
          this.runSketch();
          
          // if the test was 2d, we can just call getImageData
          if(p.use3DContext === false) {
            var context = this.canvas.getContext('2d');
            var imgData = context.getImageData(0,0,this.canvas.width,this.canvas.height).data;
            var pixels = [];
            
            for(var i = 0; i < imgData.length; i++){
              pixels[i] = imgData[i];
            }
            
            var dimensions = "[" + this.canvas.width + "," + this.canvas.height + "]";
            document.location.href= "data:text/plain;charset=utf-8;base64," + 
                                  btoa('//' + dimensions + pixels + '\n' + this.code.value);
          }
          
          // else, we'll need to call WebGL's readPixels.
          // The order of the pixels go from bottom to top, left to right.
          else {            
            // Safari returns a regular JS object for readPixels.
            // Minefield returns a WebGLUnsignedByteArray.
            // Chromium raises an exception because of an XHR bug.
            // So we need to handle each case differently.
            
            var browserString = navigator.userAgent;
            var regex = /Safari/i;
            var isSafari = browserString.match(regex);

            var context = this.canvas.getContext("experimental-webgl");
            
            // Safari returns null if format RGB is requested
            var unsignedBuffer = context.readPixels(0,0,this.canvas.width,this.canvas.height,context.RGBA, context.UNSIGNED_BYTE);
            var dimensions = "[" + this.canvas.width + "," + this.canvas.height + "]";
            var pixels = [];
            
            if(isSafari) {
              // extract the data from the WebGLUnsignedByteArray and place
              // it in a JS array for easy manipulation.
              for(var i = 0; i < unsignedBuffer.length; i++){
                pixels[i] = unsignedBuffer[i];
              }
            }

            // Minefield
            else if(!isSafari) {
              pixels = unsignedBuffer['data'];
            }

            document.location.href= "data:text/plain;charset=utf-8;base64," + 
                                  btoa('//' + dimensions + pixels.toString() + '\n' + this.code.value);
          }
        }
    };
    </script>
  </body>
</html>
